<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AnonChat Office</title>

  <!-- Tailwind CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root{
      --bg:#0b0b0f;
      --panel:#0f1724;
      --muted:#9ca3af;
      --accent1:#8b5cf6; /* purple */
      --accent2:#3b82f6; /* blue */
      --glass: rgba(255,255,255,0.03);
      --bubble-in:#111827;
      --bubble-out:#0b1220;
    }
    html,body{height:100%;background:linear-gradient(180deg,var(--bg) 0%, #05050a 100%);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .app-shell{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;}
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); box-shadow: 0 10px 30px rgba(7,7,10,0.6); border-radius:14px; }
    /* layout */
    .workspace{ width:100%; max-width:1200px; height:82vh; display:flex; overflow:hidden; }
    .sidebar{ width:300px; border-right:1px solid rgba(255,255,255,0.03); display:flex; flex-direction:column; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); }
    .main{ flex:1; display:flex; flex-direction:column; }

    /* neon header */
    .brand{ padding:20px; color:white; background:linear-gradient(90deg, rgba(139,92,246,0.06), rgba(59,130,246,0.03)); border-bottom:1px solid rgba(255,255,255,0.02); }
    .brand h1{ color: #e6e7ff; font-weight:700; letter-spacing:0.2px; }
    .codename{ color: #ffd86b; font-weight:700; font-size:13px; }

    /* lists */
    .list-item{ padding:10px 14px; border-radius:10px; display:flex; align-items:center; gap:10px; color:var(--muted); cursor:pointer; transition:all .15s; }
    .list-item:hover{ background: rgba(139,92,246,0.06); color:#fff; transform:translateY(-1px); box-shadow:0 8px 24px rgba(139,92,246,0.06); }
    .list-item.active{ background: linear-gradient(90deg, rgba(139,92,246,0.12), rgba(59,130,246,0.04)); color:white; border-right:4px solid var(--accent1); font-weight:600; }

    /* messages pane */
    .messages { padding:20px; overflow-y:auto; flex:1; display:flex; flex-direction:column; gap:12px; background:linear-gradient(180deg, rgba(255,255,255,0.003), transparent); }
    .msg-row{ display:flex; gap:10px; align-items:flex-end; }
    .msg-left{ justify-content:flex-start; }
    .msg-right{ justify-content:flex-end; }
    .bubble{ max-width:68%; padding:12px 16px; border-radius:14px; box-shadow: 0 6px 18px rgba(2,6,23,0.6); color:#e6eef8; word-wrap:break-word; }
    .bubble.me{ background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:white; border-bottom-right-radius:6px; }
    .bubble.they{ background:linear-gradient(180deg,#071025, #0b1220); color:var(--muted); border-bottom-left-radius:6px; border:1px solid rgba(255,255,255,0.03); }

    .meta{ font-size:11px; color:var(--muted); margin-top:4px; }

    /* input area */
    .composer{ display:flex; gap:8px; padding:14px; align-items:center; border-top:1px solid rgba(255,255,255,0.02); background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
    .input{ flex:1; display:flex; gap:8px; align-items:center; background:rgba(255,255,255,0.02); padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); }
    .input input{ background:transparent; border:none; outline:none; color:#e6eef8; width:100%; padding:8px; font-size:14px; }
    .btn{ background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:white; padding:10px 12px; border-radius:10px; border:none; cursor:pointer; box-shadow:0 8px 24px rgba(59,130,246,0.12); }

    /* admin panel */
    .admin-list { width:100%; overflow:auto; border-radius:8px; background:rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02); padding:8px; }
    .admin-row{ display:flex; gap:10px; align-items:center; padding:10px; border-bottom:1px solid rgba(255,255,255,0.02); color:var(--muted); }
    .admin-col{ flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:13px; color:#dbeafe; }

    /* emoji modal */
    .emoji-modal{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:var(--panel); padding:12px; border-radius:10px; width:520px; max-width:94%; box-shadow:0 18px 50px rgba(11,11,15,0.8); border:1px solid rgba(139,92,246,0.12); z-index:2000; }
    .emoji-grid{ display:grid; grid-template-columns: repeat(8,1fr); gap:6px; max-height:320px; overflow:auto; padding:8px; }
    .emoji-cell{ padding:8px; text-align:center; cursor:pointer; font-size:20px; border-radius:8px; background:transparent; transition:all .12s; }
    .emoji-cell:hover{ transform:scale(1.08); background:rgba(255,255,255,0.02); box-shadow:0 8px 20px rgba(139,92,246,0.06); }

    /* toast */
    .toast-wrap{ position:fixed; top:18px; right:18px; display:flex; flex-direction:column; gap:8px; z-index:3000; }
    .toast{ background:#0f1724; color:#e6e7ff; padding:10px 12px; border-radius:8px; border:1px solid rgba(139,92,246,0.08); box-shadow:0 12px 30px rgba(11,11,16,0.6); }

    /* auth */
    .auth-card{ width:420px; padding:26px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); color:#e6eef8; }
    .field{ background: rgba(255,255,255,0.02); padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); color:#e6eef8; }
    .muted{ color:var(--muted); font-size:13px; }

  </style>
</head>
<body>
  <!-- Loading -->
  <div id="loading" class="fixed inset-0 flex items-center justify-center" style="background:rgba(2,6,23,0.6); z-index:5000;">
    <div style="text-align:center;">
      <div style="width:56px;height:56px;border-radius:999px;border-top:4px solid var(--accent2);border-right:4px solid transparent; animation:spin 1s linear infinite; margin:0 auto;"></div>
      <div style="color:#cbd5e1; margin-top:12px;">Initializing AnonChat Office...</div>
    </div>
  </div>

  <div id="app" class="app-shell" style="display:none;">
    <div class="card workspace">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="brand p-4">
          <h1 class="text-lg">AnonChat Office</h1>
          <div class="flex justify-between items-center mt-2">
            <div>
              <div id="displayCodename" class="codename">...</div>
              <div class="muted text-xs" id="displayUid">...</div>
            </div>
            <div>
              <button id="logoutBtn" class="btn" title="Logout">Logout</button>
            </div>
          </div>
        </div>

        <div class="p-3">
          <div>
            <div class="muted text-xs mb-2">CHANNELS</div>
            <div id="channels" class="space-y-2"></div>
          </div>

          <div class="mt-4">
            <div class="muted text-xs mb-2">DIRECT MESSAGES</div>
            <div id="dms" class="space-y-2"></div>
          </div>

          <div class="mt-6">
            <button id="rulesBtn" class="w-full list-item">üìú Community Rules</button>
            <div id="adminLinkWrap" style="margin-top:8px; display:none;">
              <button id="openAdminBtn" class="w-full list-item">üõ†Ô∏è Admin Portal</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Main -->
      <div class="main">
        <!-- header -->
        <div style="padding:16px; border-bottom:1px solid rgba(255,255,255,0.02); display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div id="chatTitle" style="color:#e6e7ff; font-weight:700; font-size:18px;">Select a Channel or DM</div>
            <div class="muted text-xs" id="chatSubtitle">Choose a conversation to begin</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="emojiBtn" class="btn" title="Emoji">üòä</button>
            <div id="adminBadge" class="muted text-xs" style="padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03);">User</div>
          </div>
        </div>

        <!-- messages -->
        <div id="messagesPane" class="messages"></div>

        <!-- composer -->
        <div class="composer">
          <div class="input">
            <input id="messageInput" placeholder="Type your message..." autocomplete="off" />
          </div>
          <button id="sendBtn" class="btn">Send</button>
        </div>
      </div>

      <!-- Right / Admin Panel (hidden by default) -->
      <div id="rightPanel" style="width:420px; border-left:1px solid rgba(255,255,255,0.02); padding:18px; display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div style="color:#e6eef8; font-weight:700;">Admin ‚Äî User Management</div>
          <button id="closeAdmin" class="list-item" style="padding:6px 10px; border-radius:8px;">Close</button>
        </div>

        <div class="muted text-xs mb-3">Live Users (from public profiles)</div>
        <div id="adminUserList" class="admin-list"></div>

        <div class="mt-4 muted text-xs">Firestore Rules (use Console)</div>
        <pre style="font-size:11px; margin-top:8px; background:rgba(255,255,255,0.02); padding:8px; border-radius:6px; color:#cbd5e1;">See console for Firestore rules ‚Äî ensure bannedUsers writes restricted to admins.</pre>
      </div>
    </div>
  </div>

  <!-- Auth Modal (shown when not logged in) -->
  <div id="authModal" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(2,6,23,0.7), rgba(2,6,23,0.7)); z-index:6000;">
    <div class="auth-card">
      <h2 style="font-weight:700; color:#eef2ff; font-size:20px;">AnonChat Office ‚Äî Sign In / Register</h2>
      <div class="muted text-xs" style="margin-top:8px;">Use Email/Password to sign in. Admins will see extra controls.</div>
      <div style="margin-top:12px; display:flex; gap:8px; flex-direction:column;">
        <input id="authName" class="field" placeholder="Real name (for profile)" />
        <input id="authEmail" class="field" placeholder="Email" />
        <input id="authPass" type="password" class="field" placeholder="Password (min 6)" />
        <div style="display:flex; gap:8px;">
          <button id="signInBtn" class="btn" style="flex:1;">Sign In</button>
          <button id="signUpBtn" class="btn" style="flex:1;background:linear-gradient(90deg,var(--accent2),var(--accent1));">Register</button>
        </div>
        <div id="authError" class="muted text-xs" style="margin-top:6px; color:#ffb4b4;"></div>
      </div>
    </div>
  </div>

  <!-- Emoji Modal -->
  <div id="emojiModal" class="emoji-modal" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <div style="color:#e6eef8; font-weight:700;">Emoji Picker</div>
      <button id="closeEmoji" class="list-item" style="padding:6px 8px; border-radius:6px;">Close</button>
    </div>
    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <button class="list-item" data-cat="smile">üòÑ Smileys</button>
      <button class="list-item" data-cat="people">üßë People</button>
      <button class="list-item" data-cat="nature">üåø Nature</button>
      <button class="list-item" data-cat="food">üçî Food</button>
      <button class="list-item" data-cat="activity">‚öΩ Activity</button>
      <button class="list-item" data-cat="travel">‚úàÔ∏è Travel</button>
      <button class="list-item" data-cat="objects">üì¶ Objects</button>
    </div>
    <div id="emojiGrid" class="emoji-grid"></div>
  </div>

  <!-- Toasts -->
  <div id="toastWrap" class="toast-wrap"></div>

  <!-- Firebase + App Logic (ES modules, CDN) -->
  <script type="module">
    // Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, addDoc, serverTimestamp, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /************* CONFIG *************/
    const firebaseConfig = {
      apiKey: "AIzaSyA8kIiVqf_ZHOjIWW59JT7DWKMg9-KWVn8",
      authDomain: "anonchat-office.firebaseapp.com",
      projectId: "anonchat-office",
      storageBucket: "anonchat-office.appspot.com",
      messagingSenderId: "243690294667",
      appId: "1:243690294667:web:a8780a16761414aaa8b38e",
      measurementId: "G-X078LYJJ60"
    };

    // Admin list
    const ADMIN_EMAILS = [
      "ofloverules641@gmail.com",
      "5m0k3r.706118@gmail.com",
      "d.alonsoesthub02@gmail.com"
    ];

    // App constants
    const APP_ID = 'anonchat-office';
    const CHANNELS = ['Office Chat', 'Tea Spot', 'Project Beta', 'Random Memes'];

    // State
    let app, auth, db;
    let currentUser = null;
    let currentChatType = 'channel';
    let currentChatId = CHANNELS[0];
    let unsubscribeMessages = null;
    let codenameCache = {}; // uid -> profile data
    let bannedCache = {}; // uid -> true

    /************* DOM references *************/
    const $ = (id) => document.getElementById(id);
    const loading = document.getElementById('loading');
    const appWrap = document.getElementById('app');
    const authModal = document.getElementById('authModal');
    const authError = document.getElementById('authError');
    const signInBtn = document.getElementById('signInBtn');
    const signUpBtn = document.getElementById('signUpBtn');
    const authName = document.getElementById('authName');
    const authEmail = document.getElementById('authEmail');
    const authPass = document.getElementById('authPass');
    const logoutBtn = document.getElementById('logoutBtn');
    const displayCodename = document.getElementById('displayCodename');
    const displayUid = document.getElementById('displayUid');
    const adminBadge = document.getElementById('adminBadge');
    const channelsWrap = document.getElementById('channels');
    const dmsWrap = document.getElementById('dms');
    const messagesPane = document.getElementById('messagesPane');
    const chatTitle = document.getElementById('chatTitle');
    const chatSubtitle = document.getElementById('chatSubtitle');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiModal = document.getElementById('emojiModal');
    const emojiGrid = document.getElementById('emojiGrid');
    const closeEmoji = document.getElementById('closeEmoji');
    const toastWrap = document.getElementById('toastWrap');
    const authNameField = authName;
    const adminLinkWrap = document.getElementById('adminLinkWrap');
    const openAdminBtn = document.getElementById('openAdminBtn');
    const rightPanel = document.getElementById('rightPanel');
    const adminUserList = document.getElementById('adminUserList');
    const closeAdmin = document.getElementById('closeAdmin');
    const rulesBtn = document.getElementById('rulesBtn');
    const rulesModal = null; // not used, rules are separate screen

    /************* Firestore helpers (flattened collections to avoid path segment issues) *************/
    const profileDoc = (uid) => doc(db, 'artifacts', APP_ID, 'public_data_profiles', uid);
    const userDoc = (uid) => doc(db, 'artifacts', APP_ID, 'users', uid);
    const bannedDoc = (uid) => doc(db, 'artifacts', APP_ID, 'public_data_bannedUsers', uid);
    const channelMessagesCol = (channelId) => collection(db, 'artifacts', APP_ID, 'public_data_channels', channelId, 'messages');
    const dmMessagesCol = (dmId) => collection(db, 'artifacts', APP_ID, 'public_data_directMessages', dmId, 'messages');
    const allProfilesCol = () => collection(db, 'artifacts', APP_ID, 'public_data_profiles');
    const allBannedCol = () => collection(db, 'artifacts', APP_ID, 'public_data_bannedUsers');

    /************* Utility: Toasts *************/
    function toast(text, ms=3000) {
      const el = document.createElement('div');
      el.className = 'toast';
      el.innerText = text;
      toastWrap.appendChild(el);
      setTimeout(()=> { el.style.opacity='0'; el.style.transform='translateY(-6px)'; setTimeout(()=> el.remove(),250); }, ms);
    }

    /************* Emoji Data (a reasonably large palette) *************/
    const EMOJI_SET = {
      smile: ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üòâ','üòä','üòá','üòç','ü§©','üòò','üòó','üòö','üòã','üòú','ü§™','ü§ó','üòé','ü§î','üò¥','üò§','üò≠','üò°','üò±'],
      people: ['üßë','üë©','üë®','üë∂','üëµ','üë¥','üßî','üë±','üë≥','üë≤','üë∑','üíÇ','üïµÔ∏è','üë©‚Äç‚öïÔ∏è','üë®‚Äçüíª','üë©‚Äçüè´','üßë‚Äçüîß','üë©‚Äçüé®','üßë‚ÄçüöÄ','üë®‚Äç‚úàÔ∏è'],
      nature: ['üå±','üå≤','üå¥','üåµ','üå∫','üå∏','üåº','üåª','üåû','üåù','üåõ','üåô','‚≠ê','üåü','‚ö°','üî•','üíß','üåä','‚õ∞Ô∏è','üåã'],
      food: ['üçè','üçé','üçä','üçå','üçâ','üçá','üçì','üçí','üçë','üçç','ü•ù','üçî','üçü','üçï','üåÆ','üç£','üç±','üç™','üç©','üç∞'],
      activity: ['‚öΩ','üèÄ','üèà','‚öæ','üéæ','üèê','üèâ','üé±','üèì','üè∏','ü•ä','üèãÔ∏è','üèÑ‚Äç‚ôÇÔ∏è','üö¥‚Äç‚ôÄÔ∏è','üèá','‚õ∑Ô∏è','üèπ'],
      travel: ['üöó','üöï','üöô','üöå','üöé','üèéÔ∏è','üöì','üöë','üöí','üöö','üö≤','üõ¥','‚úàÔ∏è','üöÄ','‚õµ','üö¢','üó∫Ô∏è'],
      objects: ['‚åö','üì±','üíª','üñ•Ô∏è','üñ®Ô∏è','üéß','üì∑','üì∫','üîë','üí°','üì¶','üîí','üß≠','üõ†Ô∏è','ü™ë']
    };

    /************* Helpers: render emoji grid by category *************/
    function showEmojiCategory(cat) {
      emojiGrid.innerHTML = '';
      const items = EMOJI_SET[cat] || [];
      items.forEach(e => {
        const cell = document.createElement('div');
        cell.className = 'emoji-cell';
        cell.innerText = e;
        cell.onclick = () => {
          messageInput.value = (messageInput.value || '') + e;
          messageInput.focus();
          // keep modal open for multi-selects
        };
        emojiGrid.appendChild(cell);
      });
    }

    /************* Populate category buttons *************/
    document.querySelectorAll('[data-cat]').forEach(btn => {
      btn.addEventListener('click', () => {
        const cat = btn.getAttribute('data-cat');
        showEmojiCategory(cat);
      });
    });

    // default category
    showEmojiCategory('smile');

    /************* Render channels & DMs UI *************/
    function renderChannels() {
      channelsWrap.innerHTML = '';
      CHANNELS.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'list-item' + (currentChatType==='channel' && currentChatId===ch ? ' active' : '');
        div.innerHTML = `# ${ch}`;
        div.onclick = () => {
          currentChatType = 'channel';
          currentChatId = ch;
          openChatView();
        };
        channelsWrap.appendChild(div);
      });
    }

    async function renderDMs() {
      dmsWrap.innerHTML = '';
      // list other users from codenameCache
      const uids = Object.keys(codenameCache).filter(uid => uid !== (currentUser ? currentUser.uid : ''));
      if (uids.length === 0) {
        dmsWrap.innerHTML = '<div class="muted text-xs">No other users yet</div>';
        return;
      }
      uids.forEach(uid => {
        const profile = codenameCache[uid] || {};
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `<span style="color:#c7b3ff">${profile.codeword || 'User'}</span> ‚Ä¢ <span class="muted text-xs">${profile.realUsername || ''}</span>`;
        div.onclick = () => {
          currentChatType = 'dm';
          currentChatId = uid;
          openChatView();
        };
        dmsWrap.appendChild(div);
      });
    }

    /************* Chat open and listeners *************/
    async function openChatView() {
      chatTitle.innerText = (currentChatType === 'channel') ? `# ${currentChatId}` : `DM ‚Äî ${codenameCache[currentChatId]?.codeword || 'Private'}`;
      chatSubtitle.innerText = (currentChatType === 'channel') ? `Channel: ${currentChatId}` : `Private conversation`;
      // unsubscribe previous
      if (unsubscribeMessages) unsubscribeMessages();

      // build query
      const colRef = (currentChatType === 'channel') ? channelMessagesCol(currentChatId) : dmMessagesCol(getDmId(currentUser.uid, currentChatId));
      const q = query(colRef);

      unsubscribeMessages = onSnapshot(q, snap => {
        const arr = [];
        snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
        arr.sort((a,b) => (a.timestamp?.toMillis?.()||0) - (b.timestamp?.toMillis?.()||0));
        messagesPane.innerHTML = '';
        arr.forEach(msg => {
          messagesPane.appendChild(makeMessageNode(msg));
        });
        messagesPane.scrollTop = messagesPane.scrollHeight;
      }, err => {
        console.error("listen error", err);
        toast("No permission to read messages.");
      });
      renderChannels();
      renderDMs();
    }

    function getDmId(a,b) { return a < b ? `${a}_${b}` : `${b}_${a}`; }

    function makeMessageNode(msg) {
      const row = document.createElement('div');
      row.className = 'msg-row ' + ((msg.userId === (currentUser?.uid)) ? 'msg-right' : 'msg-left');
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + ((msg.userId === (currentUser?.uid)) ? 'me' : 'they');
      const name = document.createElement('div');
      name.style.fontSize = '12px';
      name.style.fontWeight = '600';
      name.style.marginBottom = '6px';
      const code = msg.codeword || (codenameCache[msg.userId] && codenameCache[msg.userId].codeword) || 'Anon';
      name.innerText = code;
      bubble.appendChild(name);
      const text = document.createElement('div');
      text.innerText = msg.message || '';
      bubble.appendChild(text);
      const meta = document.createElement('div');
      meta.className = 'meta';
      try {
        meta.innerText = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleString() : '';
      } catch(e) {
        meta.innerText = '';
      }
      bubble.appendChild(meta);
      row.appendChild(bubble);
      return row;
    }

    /************* Send message *************/
    async function sendMessage() {
      const txt = (messageInput.value || '').trim();
      if (!txt) return;
      if (!currentUser) { toast("Sign in to send messages"); return; }
      // check ban
      if (bannedCache[currentUser.uid]) { toast("You are banned"); return; }

      try {
        let colRef;
        if (currentChatType === 'channel') colRef = channelMessagesCol(currentChatId);
        else colRef = dmMessagesCol(getDmId(currentUser.uid, currentChatId));
        await addDoc(colRef, {
          userId: currentUser.uid,
          codeword: codenameCache[currentUser.uid]?.codeword || 'Anon',
          message: txt,
          timestamp: serverTimestamp()
        });
        messageInput.value = '';
        toast("Message sent");
      } catch (e) {
        console.error("send error", e);
        toast("Failed to send (permissions?)");
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') sendMessage(); });

    /************* Profile create/update *************/
    async function ensureProfile(uid, email, realName) {
      try {
        const ref = profileDoc(uid);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          const code = randomCodename();
          await setDoc(ref, {
            userId: uid,
            email: email || '',
            realUsername: realName || '',
            codeword: code,
            lastActive: serverTimestamp()
          });
        } else {
          // update minimal fields if provided
          const d = snap.data();
          const update = {};
          if (email && d.email !== email) update.email = email;
          if (realName && d.realUsername !== realName) update.realUsername = realName;
          if (Object.keys(update).length) await setDoc(ref, update, { merge: true });
        }
      } catch (e) {
        console.error("profile create error", e);
      }
    }

    function randomCodename() {
      const list = ["SilentPanda","DancingKoala","BraveTiger","MysticWolf","GoldenEagle","SwiftFox","CuriousCat","WhimsicalWombat","FlyingFish","JollyJellyfish","MidnightRaven","ElectricEel","WanderingWeasel","CleverCoyote","ZestyZebra"];
      return list[Math.floor(Math.random()*list.length)];
    }

    /************* Fetch all profiles into cache & render admin list *************/
    async function refreshProfilesCache() {
      try {
        const snap = await getDocs(allProfilesCol());
        codenameCache = {};
        snap.forEach(d => {
          const data = d.data();
          if (!data || !data.userId) return;
          codenameCache[data.userId] = { ...data };
        });
        renderDMs();
        renderAdminList();
      } catch (e) {
        console.error("fetch profiles err", e);
      }
    }

    async function refreshBannedCache() {
      try {
        const snap = await getDocs(allBannedCol());
        bannedCache = {};
        snap.forEach(d => { bannedCache[d.id] = true; });
        // update UI
        if (currentUser && bannedCache[currentUser.uid]) {
          // show banned
        }
      } catch (e) {
        console.error("fetch banned err", e);
      }
    }

    /************* Admin: render user list and actions *************/
    function renderAdminList() {
      adminUserList.innerHTML = '';
      const uids = Object.keys(codenameCache).sort();
      uids.forEach(uid => {
        const p = codenameCache[uid];
        const row = document.createElement('div');
        row.className = 'admin-row';
        const colA = document.createElement('div'); colA.className='admin-col'; colA.innerText = p.codeword || 'Anon';
        const colB = document.createElement('div'); colB.className='admin-col'; colB.innerText = p.realUsername || '';
        const colC = document.createElement('div'); colC.className='admin-col'; colC.innerText = p.email || '';
        const colD = document.createElement('div'); colD.className='admin-col'; colD.innerText = uid;
        const colAction = document.createElement('div');
        colAction.style.minWidth='120px';
        // ban/unban button
        const isBanned = !!bannedCache[uid];
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.style.background = isBanned ? 'linear-gradient(90deg,#10b981,#059669)' : 'linear-gradient(90deg,var(--accent1),var(--accent2))';
        btn.innerText = isBanned ? 'Unban' : 'Ban';
        btn.onclick = async () => {
          try {
            if (!currentUser) { toast("Sign in as admin"); return; }
            if (!ADMIN_EMAILS.includes(currentUser.email)) { toast("Not an admin"); return; }
            if (isBanned) {
              await deleteDoc(bannedDoc(uid));
              toast("User unbanned");
            } else {
              await setDoc(bannedDoc(uid), { bannedBy: currentUser.uid, reason: "Violated rules", timestamp: serverTimestamp() });
              toast("User banned");
            }
            await refreshBannedCache();
            renderAdminList();
          } catch (e) {
            console.error("ban error", e);
            toast("Ban action failed");
          }
        };
        colAction.appendChild(btn);

        row.appendChild(colA); row.appendChild(colB); row.appendChild(colC); row.appendChild(colD); row.appendChild(colAction);
        adminUserList.appendChild(row);
      });
    }

    /************* Banned listener realtime (keeps admin UI & ban state fresh) *************/
    function watchBannedRealtime() {
      try {
        const q = allBannedCol();
        onSnapshot(q, snap => {
          bannedCache = {};
          snap.forEach(d => bannedCache[d.id] = true);
          renderAdminList();
        }, err => console.error("banned watch err", err));
      } catch(e) {
        console.error("watch banned err", e);
      }
    }

    /************* Auth flows *************/
    async function initFirebase() {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      // hide loading
      loading.style.display = 'none';
      appWrap.style.display = 'flex';
      // auth listener
      onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if (user) {
          // storage: update UI
          displayUid.innerText = user.uid;
          adminBadge.innerText = ADMIN_EMAILS.includes(user.email) ? 'Admin' : 'User';
          try {
            await ensureProfile(user.uid, user.email || '', authNameField.value || '');
            await refreshProfilesCache();
            await refreshBannedCache();
            watchBannedRealtime();
          } catch(e){ console.error(e); }
          // fetch profiles and open default channel
          authModal.style.display = 'none';
          appWrap.style.display = 'flex';
          // show admin link if admin
          if (ADMIN_EMAILS.includes(user.email)) {
            adminLinkWrap.style.display = 'block';
          } else {
            adminLinkWrap.style.display = 'none';
          }
          displayCodename.innerText = codenameCache[user.uid]?.codeword || 'Anon';
          openChatView();
        } else {
          // show auth modal
          appWrap.style.display = 'none';
          authModal.style.display = 'flex';
        }
      });
    }

    // Sign in / Sign up handlers
    signInBtn.addEventListener('click', async () => {
      authError.innerText = '';
      const email = authEmail.value.trim(); const pass = authPass.value;
      if (!email || !pass) { authError.innerText = 'Enter email & password'; return; }
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        toast("Signed in");
      } catch (e) {
        console.error("signin err", e);
        authError.innerText = e.message;
      }
    });

    signUpBtn.addEventListener('click', async () => {
      authError.innerText = '';
      const email = authEmail.value.trim(); const pass = authPass.value; const name = authName.value.trim();
      if (!email || !pass || pass.length < 6) { authError.innerText = 'Enter name, email & password (min 6 chars)'; return; }
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        // create profile doc
        await ensureProfile(cred.user.uid, email, name);
        toast("Account created");
      } catch (e) {
        console.error("signup err", e);
        authError.innerText = e.message;
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try { await signOut(auth); toast("Signed out"); } catch(e){ console.error(e); }
    });

    /************* UI event wiring *************/
    emojiBtn.addEventListener('click', () => { emojiModal.style.display = 'block'; });
    closeEmoji.addEventListener('click', () => { emojiModal.style.display = 'none'; });
    document.getElementById('closeEmoji').onclick = () => { emojiModal.style.display = 'none'; };

    // close admin
    openAdminBtn.addEventListener('click', () => { rightPanel.style.display = 'block'; });
    closeAdmin.addEventListener('click', () => { rightPanel.style.display = 'none'; });

    // rules button (scroll to top message)
    rulesBtn.addEventListener('click', () => {
      currentChatType = 'rules';
      chatTitle.innerText = 'Community Rules';
      messagesPane.innerHTML = '';
      COMMUNITY_RULES.forEach(r => {
        const p = document.createElement('div');
        p.style.padding='12px';
        p.style.borderRadius='8px';
        p.style.background='rgba(255,255,255,0.02)';
        p.style.marginBottom='8px';
        p.innerHTML = `<strong style="color:#c7b3ff">${r.split('**')[1] || ''}</strong><div class="muted" style="margin-top:6px;">${r}</div>`;
        messagesPane.appendChild(p);
      });
    });

    /************* Misc helpers *************/
    function sanitize(text){ return String(text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // initial render
    renderChannels();

    // COMMUNITY RULES array (used above)
    const COMMUNITY_RULES = [
      "1. Professional Conduct: Always maintain a professional and respectful tone.",
      "2. Confidentiality: Keep confidential project details out of public channels.",
      "3. No Spam: Do not flood channels with irrelevant content.",
      "4. Respectful Banter: Personal attacks or harassment will result in a ban.",
      "5. Urgent Requests: Use proper channels for urgent tasks (phone/in-person).",
      "6. Policy Adherence: Follow company IT and communication policies."
    ];

    // start
    initFirebase().catch(console.error);

  </script>
</body>
</html>
