<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AnonChat Office</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg,#e0f2fe 0%,#bfdbfe 100%); }
    .scroll-area { height:60vh; overflow-y:auto; scroll-behavior:smooth; }
    .scroll-area::-webkit-scrollbar { width:8px; }
    .scroll-area::-webkit-scrollbar-thumb { background-color:#93c5fd; border-radius:4px; }
    .glow-button { transition: all .3s ease-in-out; }
    .glow-button:hover { box-shadow:0 0 10px #8b5cf6,0 0 20px #8b5cf6,0 0 30px rgba(139,92,246,.5); transform: translateY(-1px); }
    .blur-card { background-color: rgba(255,255,255,.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.3); box-shadow: 0 4px 6px rgba(0,0,0,.1); }
    .sidebar-item { cursor:pointer; transition: background-color .2s; }
    .sidebar-item:hover { background-color: rgba(238,242,255,.7); }
    .sidebar-item.active { background-color:#e0e7ff; font-weight:600; border-right:4px solid #4f46e5; }
  </style>
</head>
<body>
  <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-white z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
    <p class="ml-4 text-gray-600">Initializing Secure Connection...</p>
  </div>

  <div id="app-container" class="min-h-screen flex items-center justify-center p-4" style="display:none;">
    <!-- Auth Screen -->
    <div id="auth-screen" class="w-full max-w-md p-8 rounded-xl shadow-2xl blur-card">
      <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">AnonChat Office - Sign In</h1>
      <p class="text-center text-gray-600 mb-8">Enter credentials to access secure office communications.</p>

      <div id="auth-error" class="text-red-500 text-sm mb-4 hidden bg-red-100 p-2 rounded-lg"></div>

      <input type="text" id="real-username" placeholder="Your Real Username (e.g. John Doe)"
             class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white/80">
      <input type="email" id="email" placeholder="Email (Admin or User)"
             class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white/80">
      <input type="password" id="password" placeholder="Password"
             class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white/80">

      <button onclick="handleAuth('login')" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-300 shadow-xl mb-3 glow-button">Sign In</button>
      <button onclick="handleAuth('signup')" class="w-full bg-gray-200 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300 shadow-md hover:shadow-lg">Register New Account</button>
    </div>

    <!-- Main Content -->
    <div id="main-content-screen" class="w-full max-w-6xl rounded-xl shadow-2xl flex h-[90vh] blur-card" style="display:none;">
      <div class="w-64 bg-white/80 border-r border-gray-200 flex flex-col rounded-l-xl">
        <div class="p-4 border-b border-indigo-200 bg-indigo-700 text-white rounded-tl-xl">
          <p class="text-lg font-bold">AnonChat Office</p>
          <p class="text-xs font-light"><span id="user-codename" class="font-semibold text-yellow-300">Loading...</span></p>
          <button onclick="logout()" class="mt-2 text-xs bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-2 rounded transition">Logout</button>
        </div>

        <div class="p-4 border-b border-gray-200 space-y-2">
          <button onclick="switchView('rules','Community Rules')" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-700 p-2 rounded-lg font-semibold text-sm transition flex items-center justify-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zm-2 5a1 1 0 011-1v2a1 1 0 11-2 0v-2a1 1 0 011-1zm3 0a1 1 0 011-1v2a1 1 0 11-2 0v-2a1 1 0 011-1z" clip-rule="evenodd"/></svg>
            <span>Rules</span>
          </button>
          <div id="admin-link-container" class="hidden">
            <button id="admin-link" onclick="switchView('admin','Admin Portal')" class="w-full bg-red-100 hover:bg-red-200 text-red-700 p-2 rounded-lg font-semibold text-sm transition flex items-center justify-center space-x-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1.516a3.5 3.5 0 013.374 3.374l1.248 1.248a1 1 0 010 1.414l-1.248 1.248a3.5 3.5 0 01-3.374 3.374V17a1 1 0 11-2 0v-1.516a3.5 3.5 0 01-3.374-3.374l-1.248-1.248a1 1 0 010-1.414l1.248-1.248a3.5 3.5 0 013.374-3.374V3a1 1 0 011-1z" clip-rule="evenodd"/></svg>
              <span>Admin Portal</span>
            </button>
          </div>
        </div>

        <div class="p-4 border-b border-gray-200">
          <h3 class="text-sm font-semibold text-gray-500 uppercase mb-2">Office Channels</h3>
          <div id="channels-list"></div>
        </div>

        <div class="p-4 flex-grow overflow-y-auto">
          <h3 class="text-sm font-semibold text-gray-500 uppercase mb-2 flex justify-between items-center">Direct Messages</h3>
          <div id="dms-list"></div>
        </div>
      </div>

      <div class="flex-grow flex flex-col">
        <div class="p-4 border-b border-gray-200 bg-white/80">
          <h2 id="current-chat-title" class="text-xl font-bold text-indigo-700">Select a Channel or DM</h2>
          <p id="user-id-display" class="text-xs text-gray-500 mt-1">Your ID: <span id="user-id" class="text-gray-400">Loading...</span></p>
        </div>

        <div id="ban-notification" class="hidden text-center text-white p-3 bg-red-600 font-bold">YOU ARE CURRENTLY BANNED. Contact administrator to resolve.</div>

        <!-- Chat Screen -->
        <div id="chat-screen" class="flex-grow flex flex-col">
          <div id="messages" class="scroll-area p-5 flex-grow space-y-4">
            <p class="text-center text-gray-400 mt-10">Select a group or a user from the left to start chatting anonymously.</p>
          </div>

          <div id="input-area" class="p-4 border-t border-gray-200 flex space-x-3 bg-white/80">
            <input type="text" id="message-input" placeholder="Type your anonymous message here..."
                   class="flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white" onkeydown="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()" class="bg-indigo-600 text-white p-3 rounded-xl font-semibold hover:bg-indigo-700 transition duration-300 flex items-center justify-center shadow-lg glow-button">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
            </button>
          </div>
        </div>

        <!-- Admin Portal -->
        <div id="admin-portal-screen" class="flex-grow flex flex-col p-6 space-y-4" style="display:none;">
          <h2 class="text-3xl font-bold text-red-700 border-b pb-2">Admin Portal - User Management</h2>
          <div class="bg-yellow-50 p-3 rounded-lg text-sm text-yellow-800 border border-yellow-200">
            <p><strong>IMPORTANT:</strong> Admin actions are enforced by Firestore rules. This portal will only appear for authorized admin emails after sign-in.</p>
          </div>
          <div class="overflow-x-auto flex-grow rounded-lg border border-gray-300">
            <div id="admin-user-list" class="divide-y divide-gray-200 bg-white min-w-[700px]">
              <div class="flex items-center p-3 font-semibold bg-gray-50 text-gray-600">
                <span class="w-1/6">Codename</span>
                <span class="w-1/5">Real Name</span>
                <span class="w-1/4">Email</span>
                <span class="w-1/6 text-center">Status</span>
                <span class="w-1/6 text-center">Action</span>
              </div>
            </div>
          </div>

          <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-700 border border-gray-200">
            <h3 class="font-semibold mb-2">Firestore Rules (copy to Firebase Console)</h3>
            <pre id="rules-block" class="text-xs overflow-auto p-2 bg-white rounded border"><!-- RULES SNIPPET -->
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow authenticated users to read public resources
    match /artifacts/{appId}/public_data/{collection=**} {
      allow read: if request.auth != null;
    }
    // User profiles - owners can write their profile
    match /artifacts/{appId}/users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    // Public profiles used for listing (admins can manage)
    match /artifacts/{appId}/public_data/profiles/{uid} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.email in [
        "ofloverules641@gmail.com",
        "5m0k3r.706118@gmail.com",
        "d.alonsoesthub02@gmail.com"
      ];
    }
    // Banned users: only admins can write; authenticated users can read their own ban status
    match /artifacts/{appId}/public_data/bannedUsers/{uid} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.email in [
        "ofloverules641@gmail.com",
        "5m0k3r.706118@gmail.com",
        "d.alonsoesthub02@gmail.com"
      ];
    }
    // Channel and DM messages: authenticated users can read/write messages
    match /artifacts/{appId}/public_data/channels/{channelId}/messages/{msg} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    match /artifacts/{appId}/public_data/directMessages/{dmId}/messages/{msg} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
  }
}
            </pre>
            <p class="text-xs mt-2 text-gray-500">Important: Replace the admin email list in the rules above with your admin emails in the Firestore Console before publishing rules (the list here already matches your chosen admins).</p>
          </div>
        </div>

        <!-- Rules Screen -->
        <div id="rules-screen" class="flex-grow flex flex-col p-6 space-y-4 scroll-area" style="display:none;">
          <h2 class="text-3xl font-bold text-blue-700 border-b pb-2">AnonChat Community Rules</h2>
          <div id="rules-list" class="space-y-3"></div>
        </div>

        <div class="text-center text-xs text-gray-500 p-1 border-t border-gray-200 bg-white/80 rounded-br-xl">Developed by Dave</div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs and App Logic (CDN, ES Modules) -->
  <script type="module">
    // ---------------------------
    // Firebase config - REAL
    // ---------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, getDocs, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA8kIiVqf_ZHOjIWW59JT7DWKMg9-KWVn8",
      authDomain: "anonchat-office.firebaseapp.com",
      projectId: "anonchat-office",
      storageBucket: "anonchat-office.appspot.com",
      messagingSenderId: "243690294667",
      appId: "1:243690294667:web:a8780a16761414aaa8b38e",
      measurementId: "G-X078LYJJ60"
    };

    // Admin emails (final set)
    const ADMIN_EMAILS = [
      "ofloverules641@gmail.com",
      "5m0k3r.706118@gmail.com",
      "d.alonsoesthub02@gmail.com"
    ];

    // ---------------------------
    // App state
    // ---------------------------
    let app, db, auth, userId = null;
    let userProfile = {};
    let codenameCache = {};
    let bannedUsersCache = {};
    let isAdmin = false;
    let currentView = 'chat';
    let currentChatType = 'channel';
    let currentChatId = 'Office Chat';
    let unsubscribeListener = null;

    // ---------------------------
    // Elements
    // ---------------------------
    const elements = {
      loadingScreen: document.getElementById('loading-screen'),
      appContainer: document.getElementById('app-container'),
      authScreen: document.getElementById('auth-screen'),
      mainContentScreen: document.getElementById('main-content-screen'),
      chatScreen: document.getElementById('chat-screen'),
      adminPortalScreen: document.getElementById('admin-portal-screen'),
      rulesScreen: document.getElementById('rules-screen'),
      rulesList: document.getElementById('rules-list'),
      authError: document.getElementById('auth-error'),
      realUsername: document.getElementById('real-username'),
      email: document.getElementById('email'),
      password: document.getElementById('password'),
      messages: document.getElementById('messages'),
      messageInput: document.getElementById('message-input'),
      inputArea: document.getElementById('input-area'),
      userIdDisplay: document.getElementById('user-id'),
      userCodenameDisplay: document.getElementById('user-codename'),
      channelsList: document.getElementById('channels-list'),
      dmsList: document.getElementById('dms-list'),
      currentChatTitle: document.getElementById('current-chat-title'),
      adminLinkContainer: document.getElementById('admin-link-container'),
      adminUserList: document.getElementById('admin-user-list'),
      banNotification: document.getElementById('ban-notification')
    };

    // ---------------------------
    // Static data
    // ---------------------------
    const CHANNELS = ['Office Chat', 'Tea Spot', 'Project Beta', 'Random Memes'];
    const COMMUNITY_RULES = [
      "1. **Professional Conduct:** Always maintain a professional and respectful tone, even in the 'Tea Spot'.",
      "2. **Confidentiality:** Keep confidential project details out of public channels like 'Random Memes'. Use Direct Messages for sensitive topics.",
      "3. **No Spam:** Do not spam the 'Office Chat' channel or other groups with irrelevant content or excessive messages.",
      "4. **Respectful Banter:** Light banter is welcome, but personal attacks or harassment will result in a ban.",
      "5. **Urgent Requests:** For urgent attention, use dedicated communication channels (phone/in-person), not this chat platform.",
      "6. **Policy Adherence:** Adhere to company IT and communication policies at all times."
    ];

    const RANDOM_CODENAMES = ["SilentPanda","DancingKoala","BraveTiger","MysticWolf","GoldenEagle","SwiftFox","CuriousCat","WhimsicalWombat","FlyingFish","JollyJellyfish","MidnightRaven","ElectricEel","WanderingWeasel","CleverCoyote","ZestyZebra"];

    // ---------------------------
    // Helpers
    // ---------------------------
    function hide(el){ if(!el) return; el.style.display='none'; }
    function show(el, display='flex'){ if(!el) return; el.style.display=display; }
    function setError(message){ elements.authError.innerText = message; show(elements.authError,'block'); }
    function clearError(){ elements.authError.innerText=''; hide(elements.authError); }
    function stringToColor(str){ let hash=0; for(let i=0;i<str.length;i++){ hash = str.charCodeAt(i) + ((hash<<5)-hash); } let color='#'; for(let i=0;i<3;i++){ const value = (hash>>(i*8)) & 0xFF; color += ('00' + value.toString(16)).substr(-2); } return color; }
    function getDmId(uid1, uid2){ return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`; }
    function checkIfBanned(){ return userId && bannedUsersCache.hasOwnProperty(userId); }

    // ---------------------------
    // Firestore path helpers (use explicit projectId/appId root)
    // ---------------------------
    const APP_ID = 'anonchat-office';
    const getProfileDocRef = (uid) => doc(db, 'artifacts', APP_ID, 'users', uid);
    const getPublicProfileDocRef = (uid) => doc(db, 'artifacts', APP_ID, 'public_data', 'profiles', uid);
    const getBannedUserDocRef = (uid) => doc(db, 'artifacts', APP_ID, 'public_data', 'bannedUsers', uid);
    const getChannelsCollectionRef = (channelId) => collection(db, 'artifacts', APP_ID, 'public_data', 'channels', channelId, 'messages');
    const getDmCollectionRef = (dmId) => collection(db, 'artifacts', APP_ID, 'public_data', 'directMessages', dmId, 'messages');
    const getAllPublicProfilesCollectionRef = () => collection(db, 'artifacts', APP_ID, 'public_data', 'profiles');
    const getBannedCollectionRef = () => collection(db, 'artifacts', APP_ID, 'public_data', 'bannedUsers');

    // ---------------------------
    // Initialize Firebase
    // ---------------------------
    async function initializeFirebase(){
      try {
        if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR_API_KEY")) {
          console.warn("Firebase config looks incomplete. Paste your config.");
          hide(elements.loadingScreen);
          show(elements.appContainer);
          show(elements.authScreen,'block');
          return;
        }
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Default to anonymous sign-in to allow quick demo if user doesn't sign in
        try { await signInAnonymously(auth); } catch(e) { console.warn("Anonymous sign-in failed:", e); }

        onAuthStateChanged(auth, handleAuthStateChange);
        setupBanListener();

        console.log("âœ… Firebase initialized for project:", firebaseConfig.projectId || APP_ID);
      } catch(error) {
        console.error("Firebase initialization error:", error);
        setError(`Initialization failed: ${error.message}`);
        hide(elements.loadingScreen);
        show(elements.appContainer);
        show(elements.authScreen,'block');
      }
    }

    // ---------------------------
    // Profile management
    // ---------------------------
    async function getOrCreateProfile(uid, providedEmail = '', providedUsername = '') {
      const profileRef = getProfileDocRef(uid);
      const profileSnap = await getDoc(profileRef);
      let profileData = {};
      if (profileSnap.exists()) {
        profileData = profileSnap.data();
        if (providedEmail) profileData.email = providedEmail;
        if (providedUsername) profileData.realUsername = providedUsername;
      } else {
        const randomIndex = Math.floor(Math.random() * RANDOM_CODENAMES.length);
        const codeword = RANDOM_CODENAMES[randomIndex];
        profileData = {
          codeword,
          email: providedEmail || '',
          realUsername: providedUsername || 'Anonymous User',
          createdAt: serverTimestamp(),
          userId: uid
        };
      }
      await setDoc(profileRef, profileData, { merge: true });
      await setDoc(getPublicProfileDocRef(uid), {
        userId: uid,
        codeword: profileData.codeword,
        email: profileData.email,
        realUsername: profileData.realUsername,
        lastActive: serverTimestamp()
      }, { merge: true });

      userProfile = profileData;
      elements.userCodenameDisplay.innerText = userProfile.codeword;
      return profileData;
    }

    async function fetchAllUserProfiles(){
      try {
        const profilesSnap = await getDocs(getAllPublicProfilesCollectionRef());
        codenameCache = {};
        profilesSnap.forEach(d => {
          const data = d.data();
          codenameCache[data.userId] = {
            codeword: data.codeword,
            email: data.email,
            realUsername: data.realUsername,
            userId: data.userId
          };
        });
        renderDMList();
        renderAdminUserList();
      } catch(e) {
        console.error("fetchAllUserProfiles error:", e);
      }
    }

    // ---------------------------
    // Ban listener & logic
    // ---------------------------
    function setupBanListener(){
      try {
        const bannedRef = getBannedCollectionRef();
        onSnapshot(bannedRef, (snapshot) => {
          bannedUsersCache = {};
          snapshot.forEach(doc => { bannedUsersCache[doc.id] = true; });
          handleBanStatusUpdate();
          renderAdminUserList();
        }, (error) => {
          console.error("Ban listener error:", error);
        });
      } catch(e) {
        console.error("setupBanListener error:", e);
      }
    }

    function handleBanStatusUpdate(){
      if (!userId) return;
      const isBanned = checkIfBanned();
      if (isBanned) { show(elements.banNotification,'block'); hide(elements.inputArea); }
      else { hide(elements.banNotification); if (currentView === 'chat') show(elements.inputArea,'flex'); }
    }

    window.toggleBanUser = async (targetUid, currentStatus) => {
      if (!isAdmin || targetUid === userId) return;
      try {
        if (currentStatus === 'BANNED') {
          await deleteDoc(getBannedUserDocRef(targetUid));
          console.log(`User ${targetUid} unbanned.`);
        } else {
          await setDoc(getBannedUserDocRef(targetUid), {
            bannedBy: userId,
            bannedByName: userProfile.realUsername,
            timestamp: serverTimestamp(),
            reason: "Violated Community Guidelines (Permanent Ban until unbanned)"
          });
          console.log(`User ${targetUid} banned.`);
        }
      } catch(error) {
        console.error("toggleBanUser error:", error);
        const message = document.createElement('div');
        message.className = 'fixed top-5 right-5 p-3 bg-red-500 text-white rounded-lg shadow-xl';
        message.innerText = `Failed to change ban status: ${error.message}`;
        document.body.appendChild(message);
        setTimeout(() => document.body.removeChild(message), 3000);
      }
    };

    // ---------------------------
    // Rendering helpers
    // ---------------------------
    function renderChannelsList(){
      elements.channelsList.innerHTML = '';
      CHANNELS.forEach(channel => {
        const isActive = currentView === 'chat' && currentChatType === 'channel' && currentChatId === channel;
        const item = document.createElement('div');
        item.className = `sidebar-item p-2 rounded-lg text-gray-700 flex items-center space-x-2 ${isActive ? 'active' : ''}`;
        const icon = channel.includes('Spot')||channel.includes('Memes') ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" /></svg>`;
        item.innerHTML = `${icon}<span>#${channel}</span>`;
        item.onclick = () => switchChat('channel', channel, `Office Channel: #${channel}`);
        elements.channelsList.appendChild(item);
      });
    }

    function renderDMList(){
      elements.dmsList.innerHTML = '';
      const otherUserIds = Object.keys(codenameCache).filter(uid => uid !== userId);
      if (otherUserIds.length === 0) {
        elements.dmsList.innerHTML = '<p class="text-xs text-gray-500 italic p-2">No other users online yet.</p>'; return;
      }
      otherUserIds.forEach(targetUid => {
        const targetProfile = codenameCache[targetUid];
        const isActive = currentView === 'chat' && currentChatType === 'dm' && currentChatId === targetUid;
        const item = document.createElement('div');
        const codenameColor = stringToColor(targetProfile.codeword || 'User');
        item.className = `sidebar-item p-2 rounded-lg text-gray-700 flex items-center space-x-2 ${isActive ? 'active' : ''}`;
        item.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="${codenameColor}"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.98 5.98 0 0010 16a5.977 5.977 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" /></svg>
          <span style="color:${codenameColor};">${targetProfile.codeword}</span>
        `;
        item.onclick = () => switchChat('dm', targetUid, `Private Chat with: ${targetProfile.codeword}`);
        elements.dmsList.appendChild(item);
      });
    }

    function renderRulesList(){
      elements.rulesList.innerHTML = COMMUNITY_RULES.map(rule => `
        <div class="p-4 bg-white rounded-lg shadow-sm border-l-4 border-blue-500">
          <p class="text-sm text-gray-700">${rule}</p>
        </div>
      `).join('');
    }

    function renderAdminUserList(){
      if (!isAdmin || currentView !== 'admin') return;
      const header = elements.adminUserList.querySelector('.font-semibold.bg-gray-50');
      elements.adminUserList.innerHTML = '';
      if (header) elements.adminUserList.appendChild(header);

      const userUids = Object.keys(codenameCache).sort();
      userUids.forEach(uid => {
        const profile = codenameCache[uid];
        const isBanned = bannedUsersCache.hasOwnProperty(uid);
        const codenameColor = stringToColor(profile.codeword || 'User');
        const isSelf = uid === userId;
        const statusTag = isBanned ? `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">BANNED</span>` : `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Active</span>`;
        let actionButton;
        if (isSelf) {
          actionButton = `<span class="text-gray-400 text-xs">Admin (Self)</span>`;
        } else if (isBanned) {
          actionButton = `<button onclick="toggleBanUser('${uid}','BANNED')" class="bg-green-500 hover:bg-green-600 text-white text-xs py-1 px-3 rounded-lg transition shadow-md">Unban</button>`;
        } else {
          actionButton = `<button onclick="toggleBanUser('${uid}','ACTIVE')" class="bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-3 rounded-lg transition shadow-md">Ban</button>`;
        }
        const item = document.createElement('div');
        item.className = 'flex items-center p-3 hover:bg-indigo-50 transition border-b border-gray-100';
        item.innerHTML = `
          <span class="w-1/6 font-semibold truncate" style="color:${codenameColor};">${profile.codeword}</span>
          <span class="w-1/5 text-sm text-gray-700 truncate">${profile.realUsername || 'N/A'}</span>
          <span class="w-1/4 text-xs text-gray-500 truncate">${profile.email || 'N/A'}</span>
          <span class="w-1/6 text-center">${statusTag}</span>
          <span class="w-1/6 flex justify-center">${actionButton}</span>
        `;
        elements.adminUserList.appendChild(item);
      });
    }

    // ---------------------------
    // View switching
    // ---------------------------
    window.switchView = (view, title) => {
      currentView = view;
      hide(elements.chatScreen); hide(elements.adminPortalScreen); hide(elements.rulesScreen);

      if (view === 'admin') {
        if (!isAdmin) {
          const message = document.createElement('div');
          message.className = 'fixed top-5 right-5 p-3 bg-red-500 text-white rounded-lg shadow-xl';
          message.innerText = `You are not an authorized Admin. Access denied.`;
          document.body.appendChild(message);
          setTimeout(() => document.body.removeChild(message), 3000);
          view = 'chat'; title = elements.currentChatTitle.innerText; currentView = 'chat';
        } else {
          show(elements.adminPortalScreen,'flex'); renderAdminUserList(); hide(elements.inputArea);
          if (unsubscribeListener) { unsubscribeListener(); unsubscribeListener = null; }
        }
      } else if (view === 'rules') {
        show(elements.rulesScreen,'flex'); renderRulesList(); hide(elements.inputArea);
        if (unsubscribeListener) { unsubscribeListener(); unsubscribeListener = null; }
      } else if (view === 'chat') {
        show(elements.chatScreen,'flex'); setupChatListener(); handleBanStatusUpdate();
      }
      elements.currentChatTitle.innerText = title;
      renderChannelsList(); renderDMList();
    };

    window.switchChat = (type, id, title) => {
      currentChatType = type; currentChatId = id; switchView('chat', title);
    };

    // ---------------------------
    // Chat logic
    // ---------------------------
    async function sendMessage(){
      const messageText = elements.messageInput.value.trim();
      if (checkIfBanned()) { console.warn("Attempt blocked: User is banned."); return; }
      if (!messageText || !userProfile.codeword || !userId) return;

      let collectionRef;
      if (currentChatType === 'channel') {
        collectionRef = getChannelsCollectionRef(currentChatId);
      } else if (currentChatType === 'dm') {
        const dmId = getDmId(userId, currentChatId);
        collectionRef = getDmCollectionRef(dmId);
      } else {
        console.error("No chat selected."); return;
      }

      try {
        await addDoc(collectionRef, {
          userId: userId,
          codeword: userProfile.codeword,
          message: messageText,
          timestamp: serverTimestamp(),
          ...(currentChatType === 'dm' && { recipientId: currentChatId, senderId: userId })
        });
        elements.messageInput.value = '';
      } catch(e) { console.error("Error sending message:", e); }
    }

    function setupChatListener(){
      if (!db) return;
      if (unsubscribeListener) { unsubscribeListener(); unsubscribeListener = null; }
      let chatCollectionRef;
      if (currentChatType === 'channel') {
        chatCollectionRef = getChannelsCollectionRef(currentChatId);
      } else if (currentChatType === 'dm') {
        const dmId = getDmId(userId, currentChatId);
        chatCollectionRef = getDmCollectionRef(dmId);
      } else {
        elements.messages.innerHTML = '<p class="text-center text-gray-400 mt-10">Select a group or a user from the left to start chatting anonymously.</p>';
        return;
      }
      const q = query(chatCollectionRef);
      unsubscribeListener = onSnapshot(q, (snapshot) => {
        let messagesArray = [];
        snapshot.forEach(doc => { messagesArray.push({ id: doc.id, ...doc.data() }); });
        messagesArray.sort((a,b)=> (a.timestamp?.toMillis()||0)-(b.timestamp?.toMillis()||0));
        elements.messages.innerHTML = '';
        const fragment = document.createDocumentFragment();
        messagesArray.forEach(msg => { fragment.appendChild(createMessageElement(msg, msg.userId === userId)); });
        elements.messages.appendChild(fragment); elements.messages.scrollTop = elements.messages.scrollHeight;
      }, (error) => { console.error("Chat listener error:", error); });
    }

    function createMessageElement(msg, isCurrentUser){
      const messageContainer = document.createElement('div');
      const alignmentClass = isCurrentUser ? 'justify-end' : 'justify-start';
      const bubbleClass = isCurrentUser ? 'bg-indigo-500 text-white' : 'bg-gray-100 text-gray-800';
      const codename = msg.codeword || codenameCache[msg.userId]?.codeword || 'Unknown User';
      const codenameColor = stringToColor(codename);
      messageContainer.className = `flex ${alignmentClass}`;
      messageContainer.innerHTML = `
        <div class="max-w-xs md:max-w-md">
          <div class="text-xs mb-1 ${isCurrentUser ? 'text-right' : 'text-left'} font-semibold" style="color:${codenameColor};">${codename}</div>
          <div class="p-3 rounded-xl shadow-md ${bubbleClass} break-words">${msg.message}</div>
          <div class="text-[10px] text-gray-400 mt-1 ${isCurrentUser ? 'text-right' : 'text-left'}">${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}) : 'Sending...'}</div>
        </div>
      `;
      return messageContainer;
    }

    // ---------------------------
    // Auth handlers
    // ---------------------------
    async function handleAuthStateChange(user){
      hide(elements.loadingScreen); show(elements.appContainer);
      if (user) {
        userId = user.uid;
        const profile = await getOrCreateProfile(user.uid, user.email || '', elements.realUsername.value || 'Anonymous User');
        isAdmin = user.email ? ADMIN_EMAILS.includes(user.email) : false;
        elements.userIdDisplay.innerText = userId;
        await fetchAllUserProfiles();
        hide(elements.authScreen); show(elements.mainContentScreen,'flex');
        if (isAdmin) { show(elements.adminLinkContainer,'block'); elements.currentChatTitle.innerText = "Welcome, Admin!"; }
        else { hide(elements.adminLinkContainer); }
        handleBanStatusUpdate();
        renderChannelsList(); renderDMList();
        switchChat('channel', CHANNELS[0], `Office Channel: #${CHANNELS[0]}`);
      } else {
        userId = null; isAdmin = false;
        hide(elements.mainContentScreen); show(elements.authScreen,'block');
        elements.userCodenameDisplay.innerText = 'N/A'; elements.userIdDisplay.innerText = 'N/A';
      }
    }

    window.handleAuth = async (type) => {
      clearError();
      const email = elements.email.value;
      const password = elements.password.value;
      const realUsername = elements.realUsername.value;
      if (!email || !password || !realUsername) { setError("Please enter a Real Username, Email, and Password."); return; }
      try {
        let userCredential;
        if (type === 'signup') {
          userCredential = await createUserWithEmailAndPassword(auth, email, password);
          await getOrCreateProfile(userCredential.user.uid, email, realUsername);
        } else {
          userCredential = await signInWithEmailAndPassword(auth, email, password);
          await getOrCreateProfile(userCredential.user.uid, email, realUsername);
        }
      } catch (error) {
        let errorMessage = error.message;
        if (error.code === 'auth/email-already-in-use' && type === 'signup') errorMessage = 'This email is already registered. Please sign in instead.';
        else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') errorMessage = 'Invalid email or password.';
        else if (error.code === 'auth/weak-password') errorMessage = 'Password must be at least 6 characters.';
        console.error("Authentication Error:", error);
        setError(errorMessage);
      }
    };

    window.logout = async () => {
      if (unsubscribeListener) { unsubscribeListener(); unsubscribeListener = null; }
      try { await signOut(auth); } catch (e) { console.error("Sign out error:", e); }
    };
    window.sendMessage = sendMessage;

    // ---------------------------
    // Start app
    // ---------------------------
    initializeFirebase();
  </script>
</body>
</html>
