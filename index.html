<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AnonChat Office ‚Äî Vibrant Creative</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Import fonts */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');

    :root{
      /* Vibrant pastel palette */
      --bg:#f6f8fb;
      --panel:#ffffff;
      --muted:#6b7280;
      --accent-1:#7c3aed; /* violet */
      --accent-2:#06b6d4; /* teal */
      --accent-3:#f97316; /* orange */
      --glass: rgba(255,255,255,0.7);
      --soft: rgba(124,58,237,0.08);
      --shadow-strong: 0 14px 40px rgba(16,24,40,0.08);
      --bubble-me: linear-gradient(90deg,var(--accent-2),var(--accent-1));
      --bubble-them: linear-gradient(180deg,#eef2ff,#ffffff);
      --radius: 14px;
    }

    /* dark-mode alternate (keeps vibrancy) */
    .theme-dark {
      --bg:#0b1020;
      --panel:#0f1724;
      --muted:#9ca3af;
      --accent-1:#a78bfa;
      --accent-2:#5eead4;
      --accent-3:#fb923c;
      --glass: rgba(255,255,255,0.03);
      --soft: rgba(167,139,250,0.05);
      --shadow-strong: 0 18px 50px rgba(2,6,23,0.6);
      --bubble-me: linear-gradient(90deg,var(--accent-1),var(--accent-2));
      --bubble-them: linear-gradient(180deg,#071025,#0b1220);
      --radius: 12px;
    }

    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(1200px 500px at 10% 10%, rgba(124,58,237,0.06), transparent),
                  radial-gradient(800px 400px at 90% 90%, rgba(6,182,212,0.04), transparent),
                  var(--bg);
      font-family: "Plus Jakarta Sans", Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      color: #0f1724;
    }

    /* container */
    .app-shell{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px;}
    .card {
      width:100%;
      max-width:1300px;
      height:86vh;
      display:grid;
      grid-template-columns: 320px 1fr 360px;
      gap:20px;
      border-radius:20px;
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,0.86), rgba(255,255,255,0.82));
      box-shadow: var(--shadow-strong);
      border: 1px solid rgba(16,24,40,0.04);
      padding:18px;
    }

    /* Panels */
    .panel { border-radius:12px; background:var(--panel); padding:12px; box-shadow: 0 6px 20px rgba(14,18,25,0.03); display:flex; flex-direction:column; gap:12px; }
    .sidebar { padding:16px; height:100%; }
    .right-panel { padding:16px; height:100%; overflow:auto; }

    /* Brand */
    .brand h1{ font-size:18px; margin:0; color:var(--accent-1); font-weight:800; letter-spacing:0.2px; display:flex; align-items:center; gap:8px;}
    .brand .dot { width:10px; height:10px; background: linear-gradient(90deg,var(--accent-2),var(--accent-1)); border-radius:999px; box-shadow: 0 6px 18px rgba(124,58,237,0.12); }
    .codename{ color:var(--muted); font-weight:600; font-size:13px; margin-top:2px; }

    /* Search / create */
    .search { padding:10px; border-radius:10px; border: 1px solid rgba(14,20,30,0.03); background: linear-gradient(180deg, rgba(250,250,255,0.6), rgba(250,250,255,0.4)); color:var(--muted); }

    /* channel & dm list */
    .list { display:flex; flex-direction:column; gap:8px; overflow:auto; padding-right:6px; }
    .list-item {
      display:flex; gap:10px; align-items:center; padding:10px; border-radius:10px; cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s;
    }
    .list-item .avatar { width:36px; height:36px; border-radius:9px; display:inline-flex; align-items:center; justify-content:center; font-weight:700; color:white; }
    .list-item .meta { display:flex; flex-direction:column; }
    .list-item .title { font-weight:700; color:#0f1724; }
    .list-item .sub { font-size:12px; color:var(--muted); margin-top:2px; }

    .list-item:hover { transform: translateY(-4px); box-shadow: 0 12px 32px rgba(16,24,40,0.06); background: linear-gradient(90deg, rgba(124,58,237,0.03), rgba(6,182,212,0.02)); }

    .list-item.active {
      background: linear-gradient(90deg, rgba(124,58,237,0.08), rgba(6,182,212,0.05));
      border-left: 4px solid var(--accent-1);
      transform: none;
    }

    /* main area */
    .main { display:flex; flex-direction:column; gap:12px; overflow:hidden; }
    .header { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:6px 6px; }
    .header h2 { margin:0; font-weight:800; color: #0b1220; font-size:18px; }
    .header .muted { color:var(--muted); font-size:13px; }

    /* content split */
    .content { display:flex; gap:12px; flex:1; min-height:0; }
    .messages-pane { background: linear-gradient(180deg, rgba(250,250,255,0.7), rgba(250,250,255,0.6)); border-radius:12px; padding:14px; display:flex; flex-direction:column; gap:12px; flex:1; min-width:0; overflow:hidden; box-shadow: 0 8px 30px rgba(16,24,40,0.03); }
    .messages { flex:1; overflow:auto; display:flex; flex-direction:column; gap:12px; padding-right:8px; }

    /* pinned strip */
    .pinned-strip { display:flex; gap:8px; overflow:auto; padding:10px; border-radius:10px; background: linear-gradient(90deg, rgba(124,58,237,0.03), rgba(99,102,241,0.02)); }

    /* message rows */
    .msg-row { display:flex; gap:12px; align-items:flex-end; max-width:84%; }
    .msg-left { justify-content:flex-start; align-self:flex-start; }
    .msg-right { justify-content:flex-end; margin-left:auto; align-self:flex-end; }

    .bubble {
      padding:12px 14px;
      border-radius:12px;
      box-shadow: 0 8px 28px rgba(2,6,23,0.04);
      word-wrap:break-word;
      position:relative;
      display:inline-block;
      transition: transform .12s ease, box-shadow .12s ease;
      font-size:15px;
      line-height:1.35;
    }

    .bubble:hover { transform: translateY(-6px); box-shadow: 0 18px 40px rgba(2,6,23,0.06); }

    .bubble.me {
      background: var(--bubble-me);
      color: white;
      border-radius:16px 16px 4px 16px;
      align-self:flex-end;
      max-width:76%;
      box-shadow: 0 12px 40px rgba(6,182,212,0.12);
    }

    .bubble.they {
      background: var(--bubble-them);
      color: #0b1220;
      border-radius:16px 16px 16px 4px;
      border: 1px solid rgba(14,20,30,0.04);
      max-width:72%;
    }

    .bubble .byline { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .bubble .codename { font-weight:700; font-size:13px; color: rgba(11,17,32,0.85); }
    .bubble .time { font-size:12px; color:var(--muted); margin-left:auto; }

    .meta { font-size:12px; color:var(--muted); margin-top:8px; display:flex; justify-content:space-between; align-items:center; }

    /* composer */
    .composer { display:flex; gap:8px; padding:12px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.6)); border:1px solid rgba(14,20,30,0.03); align-items:center; }
    .composer .input { flex:1; display:flex; gap:8px; align-items:center; padding:10px; border-radius:10px; border:1px solid rgba(14,20,30,0.03); background:transparent; }
    .composer input { background:transparent; border:none; outline:none; color: #0b1220; padding:6px; width:100%; font-size:14px; }
    .btn {
      padding:10px 14px; border-radius:10px; border:none; color:white; cursor:pointer; font-weight:700; letter-spacing:0.2px;
      background: linear-gradient(90deg,var(--accent-1),var(--accent-2));
      box-shadow: 0 8px 26px rgba(124,58,237,0.12);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .btn:hover { transform: translateY(-4px); box-shadow: 0 20px 48px rgba(124,58,237,0.14); }

    .icon-btn { background:transparent; border:none; color:var(--muted); cursor:pointer; padding:8px; border-radius:8px; }
    .icon-btn:hover { color: #0b1220; background: rgba(14,20,30,0.03); transform: translateY(-3px); }

    /* right panel */
    .admin-row { display:flex; gap:8px; align-items:center; padding:8px; border-radius:8px; border-bottom:1px solid rgba(14,20,30,0.03); }
    .admin-col { flex:1; font-size:13px; color:#0b1220; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* emoji modal - floating */
    .emoji-modal { position:fixed; left:50%; top:40%; transform:translate(-50%,-40%); background:var(--panel); border-radius:12px; padding:12px; z-index:2000; width:520px; box-shadow: 0 26px 80px rgba(16,24,40,0.12); border:1px solid rgba(124,58,237,0.06); }
    .emoji-grid { display:grid; grid-template-columns:repeat(8,1fr); gap:8px; max-height:320px; overflow:auto; padding:6px; }
    .emoji-cell { padding:8px; font-size:20px; text-align:center; cursor:pointer; border-radius:8px; transition:transform .08s ease; }
    .emoji-cell:hover { transform:scale(1.08); background: rgba(14,20,30,0.02); }

    /* small utilities */
    .hidden { display:none !important; }
    .muted { color:var(--muted); }
    .toasts { position:fixed; top:22px; right:22px; display:flex; flex-direction:column; gap:10px; z-index:4000; }
    .toast { background:var(--panel); color:#0b1220; padding:10px 12px; border-radius:10px; border:1px solid rgba(14,20,30,0.04); box-shadow: 0 12px 36px rgba(16,24,40,0.06); }

    /* scrollbar subtle */
    ::-webkit-scrollbar { height:10px; width:10px; }
    ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(0,0,0,0.08), rgba(0,0,0,0.12)); border-radius:999px; }
    ::-webkit-scrollbar-track { background: transparent; }

    /* responsive */
    @media (max-width: 1100px){
      .card { grid-template-columns: 1fr; height:92vh; padding:10px; gap:10px; }
      .right-panel { display:none; }
      .sidebar { order:2; }
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loadingOverlay" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(11,17,32,0.5);z-index:8000;">
    <div style="text-align:center;color:#e6eef8;">
      <div style="width:64px;height:64px;border-radius:999px;background:linear-gradient(90deg,var(--accent-2),var(--accent-1)); box-shadow:0 12px 40px rgba(124,58,237,0.18); display:flex; align-items:center; justify-content:center; font-weight:800; color:white; font-size:20px;">AC</div>
      <div style="margin-top:12px;">Loading AnonChat Office...</div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toasts" class="toasts"></div>

  <div id="appShell" class="app-shell" style="display:none;">
    <div class="card">
      <!-- Left Sidebar -->
      <div class="panel sidebar">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div class="brand"><span class="dot"></span><h1 style="display:inline-block;margin-left:6px">AnonChat Office</h1></div>
            <div id="codenameDisplay" class="codename">‚Äî</div>
            <div id="uidDisplay" class="muted" style="font-size:12px;">‚Äî</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
            <button id="logoutBtn" class="btn" title="Logout" style="background: linear-gradient(90deg,var(--accent-2),var(--accent-1)); padding:8px 10px; font-size:13px;">Logout</button>
            <button id="themeToggle" class="icon-btn" title="Toggle theme" style="margin-top:4px;">üåì</button>
          </div>
        </div>

        <div>
          <div style="display:flex;gap:8px;margin-top:12px;">
            <input id="searchLeft" class="search flex-1" placeholder="Search channels & people..." />
            <button id="newChatBtn" class="btn" title="New">Ôºã</button>
          </div>
        </div>

        <div style="margin-top:12px;">
          <div class="muted" style="font-size:12px;margin-bottom:6px;">CHANNELS</div>
          <div id="channelsList" class="list"></div>
        </div>

        <div style="margin-top:8px;">
          <div class="muted" style="font-size:12px;margin-bottom:6px;">DIRECT MESSAGES</div>
          <div id="dmsList" class="list" style="max-height:220px;"></div>
        </div>

        <div style="margin-top:auto;display:flex;flex-direction:column;gap:8px;">
          <button id="rulesBtn" class="list-item" style="justify-content:space-between;">üìú <span class="sub" style="margin-left:8px">Community Rules</span></button>

          <div id="adminLinkWrap" style="display:none; margin-top:8px;">
            <button id="openAdminBtn" class="list-item" style="justify-content:space-between;">üõ†Ô∏è <span class="sub" style="margin-left:8px">Admin Portal</span></button>
          </div>
        </div>
      </div>

      <!-- Middle main -->
      <div class="panel main">
        <div class="header">
          <div>
            <h2 id="chatTitle">Select a Channel or DM</h2>
            <div id="chatSubtitle" class="muted">Choose a conversation to begin</div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;">
            <input id="searchInput" class="search" placeholder="Search messages..." style="width:320px;"/>
            <div id="adminBadge" class="muted" style="padding:6px 10px;border-radius:10px;border:1px solid rgba(14,20,30,0.03);">User</div>
          </div>
        </div>

        <div class="content">
          <div class="messages-pane">
            <div id="pinnedStrip" class="pinned-strip hidden"></div>
            <div id="messages" class="messages"></div>

            <div class="composer">
              <div class="input">
                <input id="messageInput" placeholder="Type a message..." autocomplete="off" />
              </div>
              <button id="emojiBtn" class="icon-btn" title="Emoji">üòä</button>
              <button id="sendBtn" class="btn">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Admin Panel -->
      <div id="rightPanel" class="panel right-panel hidden" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:800;color:#0b1220;">Admin ‚Äî User Management</div>
          <button id="closeAdmin" class="icon-btn">‚úñ</button>
        </div>

        <div class="muted text-xs">Live Users (profiles)</div>
        <div id="adminUserList" class="admin-list"></div>

        <div style="margin-top:8px;">
          <div class="muted text-xs">Pinned messages (channel)</div>
          <div id="adminPinnedList" style="margin-top:6px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth modal (email + password only) -->
  <div id="authModal" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(11,17,32,0.6), rgba(11,17,32,0.6));z-index:7000;">
    <div style="width:420px;background:var(--panel);padding:20px;border-radius:12px;border:1px solid rgba(14,20,30,0.03); box-shadow:0 20px 60px rgba(16,24,40,0.08);">
      <h2 style="color:var(--accent-1);margin:0 0 8px 0;font-weight:800;">AnonChat Office ‚Äî Sign In / Register</h2>
      <div class="muted text-xs" style="margin-bottom:12px;">Sign in with Email + Password. Admin accounts show extra controls.</div>

      <div style="display:flex;flex-direction:column;gap:10px;">
        <input id="authEmail" placeholder="Email" style="padding:12px;border-radius:10px;border:1px solid rgba(14,20,30,0.03);background:transparent;color: #0b1220;" />
        <input id="authPass" type="password" placeholder="Password (min 6)" style="padding:12px;border-radius:10px;border:1px solid rgba(14,20,30,0.03);background:transparent;color:#0b1220;" />
        <div style="display:flex;gap:8px;">
          <button id="signInBtn" class="btn" style="flex:1;background: linear-gradient(90deg,var(--accent-2),var(--accent-1));">Sign In</button>
          <button id="signUpBtn" class="btn" style="flex:1;background: linear-gradient(90deg,var(--accent-1),var(--accent-3));">Register</button>
        </div>
        <div id="authError" class="muted text-xs" style="color:#ef4444;"></div>
      </div>
    </div>
  </div>

  <!-- Emoji modal -->
  <div id="emojiModal" class="emoji-modal hidden" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <div style="color:var(--accent-1);font-weight:800;">Emoji Palette</div>
      <div><button id="closeEmoji" class="icon-btn">Close</button></div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:8px;">
      <button data-cat="smile" class="icon-btn">üòÑ</button>
      <button data-cat="people" class="icon-btn">üßë</button>
      <button data-cat="nature" class="icon-btn">üåø</button>
      <button data-cat="food" class="icon-btn">üçî</button>
      <button data-cat="activity" class="icon-btn">‚öΩ</button>
      <button data-cat="travel" class="icon-btn">‚úàÔ∏è</button>
      <button data-cat="objects" class="icon-btn">üì¶</button>
    </div>

    <div id="emojiGrid" class="emoji-grid"></div>
  </div>

  <script type="module">
    // Firebase imports (CDN) - kept exactly as earlier so your logic keeps working
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, addDoc, serverTimestamp, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // -------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyA8kIiVqf_ZHOjIWW59JT7DWKMg9-KWVn8",
      authDomain: "anonchat-office.firebaseapp.com",
      projectId: "anonchat-office",
      storageBucket: "anonchat-office.appspot.com",
      messagingSenderId: "243690294667",
      appId: "1:243690294667:web:a8780a16761414aaa8b38e",
      measurementId: "G-X078LYJJ60"
    };

    // Admin emails
    const ADMIN_EMAILS = [
      "ofloverules641@gmail.com",
      "5m0k3r.706118@gmail.com",
      "d.alonsoesthub02@gmail.com"
    ];

    // App constants & state
    const APP_ID = 'anonchat-office';
    const CHANNELS = ['Office Chat','Tea Spot','Project Beta','Random Memes'];
    let app, auth, db;
    let currentUser = null;
    let currentChatType = 'channel'; // 'channel' or 'dm'
    let currentChatId = CHANNELS[0];
    let unsubscribeMessages = null;
    let profilesCache = {}; // uid -> profile data
    let bannedCache = {};   // uid -> true
    let pinnedCache = {};   // pinned msg ids per channel
    let dmMetaCache = {};   // dmId -> meta doc (lastSeen fields)

    // DOM refs
    const $ = id => document.getElementById(id);
    const loadingOverlay = $('loadingOverlay');
    const appShell = $('appShell');
    const authModal = $('authModal');
    const authEmail = $('authEmail');
    const authPass = $('authPass');
    const signInBtn = $('signInBtn');
    const signUpBtn = $('signUpBtn');
    const authError = $('authError');
    const logoutBtn = $('logoutBtn');
    const codenameDisplay = $('codenameDisplay');
    const uidDisplay = $('uidDisplay');
    const adminBadge = $('adminBadge');
    const channelsList = $('channelsList');
    const dmsList = $('dmsList');
    const messagesDiv = $('messages');
    const messageInput = $('messageInput');
    const sendBtn = $('sendBtn');
    const emojiBtn = $('emojiBtn');
    const emojiModal = $('emojiModal');
    const emojiGrid = $('emojiGrid');
    const closeEmoji = $('closeEmoji');
    const searchInput = $('searchInput');
    const toasts = $('toasts');
    const adminLinkWrap = $('adminLinkWrap');
    const openAdminBtn = $('openAdminBtn');
    const rightPanel = $('rightPanel');
    const adminUserList = $('adminUserList');
    const closeAdmin = $('closeAdmin');
    const rightPanelEl = $('rightPanel');
    const pinnedStrip = $('pinnedStrip');
    const adminPinnedList = $('adminPinnedList');
    const rulesBtn = $('rulesBtn');
    const themeToggle = $('themeToggle');

    // Firestore path helpers
    const userDocRef = (uid) => doc(db, 'artifacts', APP_ID, 'users', uid);
    const profileDocRef = (uid) => doc(db, 'artifacts', APP_ID, 'public_data_profiles', uid);
    const bannedDocRef = (uid) => doc(db, 'artifacts', APP_ID, 'public_data_bannedUsers', uid);
    const channelMessagesColRef = (channelId) => collection(db, 'artifacts', APP_ID, 'public_data_channels', channelId, 'messages');
    const channelPinnedColRef = (channelId) => collection(db, 'artifacts', APP_ID, 'public_data_channels', channelId, 'pinned');
    const dmMessagesColRef = (dmId) => collection(db, 'artifacts', APP_ID, 'public_data_directMessages', dmId, 'messages');
    const dmMetaDocRef = (dmId) => doc(db, 'artifacts', APP_ID, 'public_data_directMessages', dmId + '_meta');
    const allProfilesColRef = () => collection(db, 'artifacts', APP_ID, 'public_data_profiles');
    const allBannedColRef = () => collection(db, 'artifacts', APP_ID, 'public_data_bannedUsers');

    // ---------- UI helpers ----------
    function showToast(text, ms=3000){
      const el = document.createElement('div');
      el.className = 'toast';
      el.innerText = text;
      toasts.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(-6px)'; setTimeout(()=>el.remove(),300); }, ms);
    }

    // Theme auto/dark toggle
    function setThemeAuto(){
      const stored = localStorage.getItem('anonchat_theme');
      if(stored === 'dark') document.documentElement.classList.add('theme-dark');
      else if(stored === 'light') document.documentElement.classList.remove('theme-dark');
      else {
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if(prefersDark) document.documentElement.classList.add('theme-dark'); else document.documentElement.classList.remove('theme-dark');
      }
    }
    setThemeAuto();
    themeToggle?.addEventListener('click', ()=>{
      const isDark = document.documentElement.classList.toggle('theme-dark');
      localStorage.setItem('anonchat_theme', isDark ? 'dark' : 'light');
    });

    // Emoji data
    const EMOJI_SET = {
      smile:['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üòâ','üòä','üòç','üòò','üòó','üòö','üòã','ü§™','ü§©'],
      people:['üßë','üë©','üë®','üë∂','üëµ','üë¥','üßî','üë±','üë≥','üë≤','üë∑','üíÇ','üïµÔ∏è','üë®‚Äçüíª','üë©‚Äç‚öïÔ∏è'],
      nature:['üå±','üå≤','üå≥','üå¥','üåµ','üå∫','üå∏','üåº','üåª','üåû','‚≠ê','üåô','‚ö°','üî•','üíß','üåä'],
      food:['üçè','üçé','üçä','üçå','üçâ','üçì','üçï','üçî','üçü','üç£','üç©','üç∞'],
      activity:['‚öΩ','üèÄ','üèà','üéæ','üèê','üé±','üèì','üè∏','üèÑ','üö¥'],
      travel:['üöó','üöï','üöå','‚úàÔ∏è','üöÄ','üö¢','üö≤'],
      objects:['‚åö','üì±','üíª','üéß','üì∑','üì¶','üîí','üí°']
    };

    function populateEmojiCategory(cat){
      emojiGrid.innerHTML = '';
      (EMOJI_SET[cat]||[]).forEach(e=>{
        const c = document.createElement('div');
        c.className='emoji-cell';
        c.innerText = e;
        c.onclick = ()=>{ messageInput.value += e; messageInput.focus(); emojiModal.style.display='none'; emojiModal.classList.add('hidden'); };
        emojiGrid.appendChild(c);
      });
    }
    populateEmojiCategory('smile');

    document.querySelectorAll('[data-cat]').forEach(btn=>{
      btn.addEventListener('click', ()=> populateEmojiCategory(btn.dataset.cat));
    });

    // ---------- Firebase init ----------
    async function init(){
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);

      // UI ready
      loadingOverlay.style.display = 'none';
      appShell.style.display = 'flex';

      // auth listener
      onAuthStateChanged(auth, async (user)=>{
        currentUser = user;
        if(!user){
          authModal.style.display = 'flex';
          appShell.style.display = 'none';
          return;
        }
        authModal.style.display = 'none';
        appShell.style.display = 'flex';
        uidDisplay.innerText = user.uid;
        adminBadge.innerText = ADMIN_EMAILS.map(e=>e.toLowerCase()).includes((user.email||'').toLowerCase()) ? 'Admin' : 'User';
        // ensure profile document exists (auto create)
        await ensureProfile(user.uid, user.email||'');
        // refresh caches
        await refreshProfiles();
        await refreshBanned();
        await refreshPinned(currentChatId);
        // show admin link if admin
        if(ADMIN_EMAILS.map(e=>e.toLowerCase()).includes((user.email||'').toLowerCase())) adminLinkWrap.style.display='block'; else adminLinkWrap.style.display='none';
        codenameDisplay.innerText = profilesCache[user.uid]?.codeword || 'Anon';
        openChat(currentChatType, currentChatId);
        watchBannedRealtime();
      });
    }

    // ---------- Auth handlers ----------
    signInBtn.addEventListener('click', async ()=>{
      authError.innerText = '';
      const email = authEmail.value.trim(); const pass = authPass.value;
      if(!email || !pass){ authError.innerText='Enter email & password'; return; }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        showToast('Signed in');
      }catch(e){ console.error(e); authError.innerText = e.message; }
    });

    signUpBtn.addEventListener('click', async ()=>{
      authError.innerText = '';
      const email = authEmail.value.trim(); const pass = authPass.value;
      if(!email || !pass || pass.length < 6){ authError.innerText='Enter email & password (min 6)'; return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await ensureProfile(cred.user.uid, email);
        showToast('Account created');
      }catch(e){ console.error(e); authError.innerText = e.message; }
    });

    logoutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); showToast('Signed out'); }catch(e){console.error(e)} });

    // ---------- Profile helpers ----------
    async function ensureProfile(uid, email=''){
      try{
        const ref = profileDocRef(uid);
        const snap = await getDoc(ref);
        if(!snap.exists()){
          const codename = randomCodename();
          await setDoc(ref, { userId: uid, email: email||'', realUsername:'', codeword: codename, lastActive: serverTimestamp() });
        } else {
          // update email if missing
          const data = snap.data();
          if(email && data.email !== email) await setDoc(ref, { email }, { merge:true });
        }
      }catch(e){ console.error('ensureProfile err', e); }
    }

    function randomCodename(){
      const list = ["SilentPanda","DancingKoala","BraveTiger","MysticWolf","GoldenEagle","SwiftFox","CuriousCat","WhimsicalWombat","FlyingFish","JollyJellyfish","MidnightRaven","ElectricEel","WanderingWeasel","CleverCoyote","ZestyZebra"];
      return list[Math.floor(Math.random()*list.length)];
    }

    // ---------- Caches ----------
    async function refreshProfiles(){
      try{
        const snap = await getDocs(allProfilesColRef());
        profilesCache = {};
        snap.forEach(d=>{ const data = d.data(); if(data && data.userId) profilesCache[data.userId] = data; });
        renderDMList();
        renderAdminList();
      }catch(e){ console.error('refreshProfiles', e); }
    }

    async function refreshBanned(){
      try{
        const snap = await getDocs(allBannedColRef());
        bannedCache = {};
        snap.forEach(d=> bannedCache[d.id] = true);
        renderAdminList();
      }catch(e){ console.error('refreshBanned', e); }
    }

    async function refreshPinned(channelId){
      try{
        const col = channelPinnedColRef(channelId);
        const snap = await getDocs(col);
        pinnedCache[channelId] = {};
        snap.forEach(d=>{
          pinnedCache[channelId][d.id] = d.data();
        });
        renderPinnedStrip(channelId);
      }catch(e){ pinnedCache[channelId] = {}; renderPinnedStrip(channelId); }
    }

    function watchBannedRealtime(){
      try{
        onSnapshot(allBannedColRef(), snap=>{
          bannedCache = {};
          snap.forEach(d=> bannedCache[d.id] = true);
          renderAdminList();
        }, e=> console.error('banned watch', e));
      }catch(e){ console.error(e); }
    }

    // ---------- UI renderers ----------
    function renderChannels(){
      channelsList.innerHTML = '';
      CHANNELS.forEach(ch=>{
        const el = document.createElement('div');
        el.className = 'list-item' + ((currentChatType==='channel' && currentChatId===ch)?' active':'');
        el.innerHTML = `<div class="avatar" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));">${ch[0]}</div>
                        <div class="meta"><div class="title"># ${ch}</div><div class="sub">Channel</div></div>`;
        el.onclick = ()=> openChat('channel', ch);
        channelsList.appendChild(el);
      });
    }

    function renderDMList(){
      dmsList.innerHTML = '';
      const uids = Object.keys(profilesCache).filter(u=> u !== (currentUser?.uid));
      if(uids.length === 0){ dmsList.innerHTML = '<div class="muted">No other users yet</div>'; return; }
      uids.forEach(uid=>{
        const p = profilesCache[uid];
        const el = document.createElement('div');
        el.className = 'list-item';
        const avatarColor = stringToColor(p.codeword || 'A');
        el.innerHTML = `<div class="avatar" style="background:${avatarColor};">${(p.codeword||'Anon').slice(0,2)}</div>
                        <div class="meta"><div class="title">${p.codeword || 'Anon'}</div><div class="sub">${p.realUsername||''}</div></div>`;
        el.onclick = ()=> openChat('dm', uid);
        dmsList.appendChild(el);
      });
    }

    function stringToColor(s){
      // simple pastel generator
      const colors = ['linear-gradient(90deg,#ffd6ba,#ffd6f2)','linear-gradient(90deg,#bfe9ff,#d3b8ff)','linear-gradient(90deg,#ffef9f,#ffc4d6)','linear-gradient(90deg,#c8f7dc,#bde0ff)'];
      let h = 0;
      for(let i=0;i<s.length;i++) h = (h<<5)-h + s.charCodeAt(i);
      return colors[Math.abs(h)%colors.length];
    }

    function renderAdminList(){
      adminUserList.innerHTML = '';
      const uids = Object.keys(profilesCache).sort();
      uids.forEach(uid=>{
        const p = profilesCache[uid];
        const row = document.createElement('div'); row.className='admin-row';
        const c1 = document.createElement('div'); c1.className='admin-col'; c1.innerText = p.codeword || 'Anon';
        const c2 = document.createElement('div'); c2.className='admin-col'; c2.innerText = p.realUsername || '';
        const c3 = document.createElement('div'); c3.className='admin-col'; c3.innerText = p.email || '';
        const c4 = document.createElement('div'); c4.className='admin-col'; c4.innerText = uid;
        const action = document.createElement('div'); action.style.minWidth='120px';
        const isBanned = !!bannedCache[uid];
        const btn = document.createElement('button'); btn.className='btn';
        btn.style.background = isBanned ? 'linear-gradient(90deg,#10b981,#059669)' : 'linear-gradient(90deg,var(--accent-1),var(--accent-2))';
        btn.innerText = isBanned ? 'Unban' : 'Ban';
        btn.onclick = async ()=>{
          if(!currentUser) { showToast('Sign in as admin'); return; }
          if(!ADMIN_EMAILS.map(e=>e.toLowerCase()).includes((currentUser.email||'').toLowerCase())) { showToast('Not an admin'); return; }
          try{
            if(isBanned) await deleteDoc(bannedDocRef(uid));
            else await setDoc(bannedDocRef(uid), { bannedBy: currentUser.uid, timestamp: serverTimestamp() });
            showToast(isBanned ? 'Unbanned' : 'Banned');
            await refreshBanned();
          }catch(e){ console.error(e); showToast('Action failed'); }
        };
        action.appendChild(btn);
        row.appendChild(c1); row.appendChild(c2); row.appendChild(c3); row.appendChild(c4); row.appendChild(action);
        adminUserList.appendChild(row);
      });
    }

    function renderPinnedStrip(channelId){
      const pinned = pinnedCache[channelId] || {};
      if(Object.keys(pinned).length === 0){ pinnedStrip.classList.add('hidden'); pinnedStrip.innerHTML=''; return; }
      pinnedStrip.classList.remove('hidden');
      pinnedStrip.innerHTML = '';
      Object.keys(pinned).forEach(pid=>{
        const data = pinned[pid];
        const el = document.createElement('div'); el.className='pinned-item';
        el.style.padding = '10px';
        el.style.borderRadius = '10px';
        el.style.background = 'linear-gradient(90deg, rgba(124,58,237,0.08), rgba(6,182,212,0.03))';
        el.innerText = data.message ? (data.message.length>80?data.message.slice(0,77)+'...':data.message) : '[pinned]';
        pinnedStrip.appendChild(el);
      });
    }

    // ---------- Chat open / listeners ----------
    async function openChat(type, id){
      currentChatType = type; currentChatId = id;
      $('chatTitle').innerText = (type==='channel')?`# ${id}`:`DM ‚Äî ${profilesCache[id]?.codeword || 'Private'}`;
      $('chatSubtitle').innerText = (type==='channel')?`Channel: ${id}`:'Private conversation';
      if(unsubscribeMessages) unsubscribeMessages();
      messagesDiv.innerHTML = '';

      if(type==='channel') await refreshPinned(id);

      let colRef;
      if(type==='channel') colRef = channelMessagesColRef(id);
      else colRef = dmMessagesColRef(getDmId(currentUser.uid, id));

      const q = query(colRef);
      unsubscribeMessages = onSnapshot(q, snap=>{
        const arr = [];
        snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
        arr.sort((a,b)=>(a.timestamp?.toMillis?.()||0)-(b.timestamp?.toMillis?.()||0));
        messagesDiv.innerHTML = '';
        arr.forEach(m=> messagesDiv.appendChild(makeMessageNode(m)));
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        updateAutoClearTimers(type, id, arr);
      }, err=>{
        console.error('listen error', err);
        showToast('No permission to read messages');
      });

      if(type==='dm') await updateDmLastSeen(getDmId(currentUser.uid, id), currentUser.uid);

      renderChannels();
      renderDMList();

      // watch DM meta (so seen receipts update)
      if(type === 'dm') setupDmMetaWatcher(getDmId(currentUser.uid, id));
    }

    function getDmId(a,b){ return a < b ? `${a}_${b}` : `${b}_${a}`; }

    function makeMessageNode(msg){
      const container = document.createElement('div');
      container.className = 'msg-row ' + ((msg.userId === currentUser?.uid) ? 'msg-right' : 'msg-left');

      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + ((msg.userId === currentUser?.uid) ? 'me' : 'they');

      // byline
      const byline = document.createElement('div');
      byline.className = 'byline';
      const name = document.createElement('div'); name.className='codename'; name.innerText = msg.codeword || profilesCache[msg.userId]?.codeword || 'Anon';
      const time = document.createElement('div'); time.className='time muted';
      try{ time.innerText = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString() : '...'; }catch(e){ time.innerText='...'; }
      byline.appendChild(name);
      byline.appendChild(time);
      bubble.appendChild(byline);

      // content
      const text = document.createElement('div'); text.style.whiteSpace='pre-wrap'; text.innerText = msg.message || '';
      bubble.appendChild(text);

      // controls (pin/delete) appear on hover ‚Äî keep simple inline controls for now
      const ctrl = document.createElement('div'); ctrl.style.marginTop='8px'; ctrl.style.display='flex'; ctrl.style.gap='8px';
      if(currentChatType === 'channel'){
        const pinBtn = document.createElement('button'); pinBtn.className='icon-btn'; pinBtn.title='Pin message'; pinBtn.innerText = 'üìå';
        pinBtn.onclick = async (ev)=>{ ev.stopPropagation(); try{ await setDoc(doc(channelPinnedColRef(currentChatId), msg.id), { message: msg.message, pinnedAt: serverTimestamp(), pinnedBy: currentUser.uid }); showToast('Pinned'); await refreshPinned(currentChatId); }catch(e){console.error(e); showToast('Pin failed'); } };
        ctrl.appendChild(pinBtn);
      }
      const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.title='Delete message'; delBtn.innerText = 'üóëÔ∏è';
      delBtn.onclick = async (ev)=>{ ev.stopPropagation(); if(!(msg.userId === currentUser.uid || ADMIN_EMAILS.map(e=>e.toLowerCase()).includes((currentUser.email||'').toLowerCase()))){ showToast('Not allowed to delete this message'); return; } if(!confirm('Delete this message for everyone?')) return; try{ await deleteDoc(doc((currentChatType==='channel')?channelMessagesColRef(currentChatId):dmMessagesColRef(getDmId(currentUser.uid,currentChatId)), msg.id)); showToast('Message deleted'); }catch(e){ console.error('delete err', e); showToast('Delete failed'); } };
      ctrl.appendChild(delBtn);
      bubble.appendChild(ctrl);

      container.appendChild(bubble);
      return container;
    }

    // ---------- Send message ----------
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendMessage(); });

    async function sendMessage(){
      const txt = (messageInput.value||'').trim();
      if(!txt) return;
      if(!currentUser){ showToast('Sign in to send'); return; }
      if(bannedCache[currentUser.uid]) { showToast('You are banned'); return; }
      try{
        const payload = { userId: currentUser.uid, codeword: profilesCache[currentUser.uid]?.codeword || 'Anon', message: txt, timestamp: serverTimestamp() };
        if(currentChatType === 'channel'){
          await addDoc(channelMessagesColRef(currentChatId), payload);
        } else {
          const dmId = getDmId(currentUser.uid, currentChatId);
          await addDoc(dmMessagesColRef(dmId), payload);
          await setDoc(dmMetaDocRef(dmId), { [currentUser.uid]: serverTimestamp() }, { merge:true });
        }
        messageInput.value = '';
        showToast('Message sent');
      }catch(e){ console.error('send err', e); showToast('Send failed'); }
    }

    // ---------- DM meta (read receipts) ----------
    async function updateDmLastSeen(dmId, uid){
      try{ await setDoc(dmMetaDocRef(dmId), { [uid]: serverTimestamp() }, { merge:true }); }catch(e){ console.error('dm lastSeen err', e); }
    }

    function setupDmMetaWatcher(dmId){
      try{
        const ref = dmMetaDocRef(dmId);
        onSnapshot(ref, snap=>{
          dmMetaCache[dmId] = snap.exists() ? snap.data() : {};
          if(currentChatType === 'dm' && getDmId(currentUser.uid, currentChatId) === dmId) openChat(currentChatType, currentChatId);
        }, err=> console.error('dm meta watch', err));
      }catch(e){ console.error(e); }
    }

    // ---------- Search ----------
    searchInput.addEventListener('input', ()=>{
      const q = searchInput.value.trim().toLowerCase();
      const nodes = messagesDiv.querySelectorAll('.bubble');
      nodes.forEach(n=>{
        const text = n.innerText.toLowerCase();
        if(!q) n.parentElement.style.display='flex';
        else n.parentElement.style.display = text.includes(q) ? 'flex' : 'none';
      });
    });

    // ---------- Auto-clear UI timers ----------
    const autoClearTimers = {}; // key -> timeout id
    function updateAutoClearTimers(type, id, messagesArray){
      const lastTs = messagesArray.length ? (messagesArray[messagesArray.length-1].timestamp?.toMillis?.()||0) : 0;
      const key = (type==='channel' ? 'channel_' + id : 'dm_' + id);
      if(autoClearTimers[key]) clearTimeout(autoClearTimers[key]);
      const duration = (type==='channel') ? (10 * 60 * 1000) : (60 * 60 * 1000);
      const now = Date.now();
      const timeSince = lastTs ? (now - lastTs) : duration + 1;
      if(timeSince >= duration){
        messagesDiv.innerHTML = '';
        showToast((type==='channel') ? 'Channel cleared from view (idle)' : 'DM cleared from view (idle)');
      } else {
        autoClearTimers[key] = setTimeout(()=>{ messagesDiv.innerHTML = ''; showToast((type==='channel') ? 'Channel cleared from view (idle)' : 'DM cleared from view (idle)'); }, duration - timeSince);
      }
    }

    // ---------- Admin controls UI wiring ----------
    openAdminBtn.addEventListener('click', ()=>{ rightPanel.style.display='block'; rightPanelEl.style.display='block'; refreshPinnedListUI(currentChatId); });
    closeAdmin.addEventListener('click', ()=>{ rightPanel.style.display='none'; rightPanelEl.style.display='none'; });

    function refreshPinnedListUI(channelId){
      adminPinnedList.innerHTML = '';
      const pinned = pinnedCache[channelId] || {};
      Object.keys(pinned).forEach(pid=>{
        const p = pinned[pid];
        const el = document.createElement('div'); el.className='admin-row';
        el.innerHTML = `<div style="flex:1;color:var(--accent-1);font-weight:700">${(p.message||'').slice(0,80)}</div>`;
        const delbtn = document.createElement('button'); delbtn.className='btn'; delbtn.innerText='Remove pin';
        delbtn.onclick = async ()=>{ try{ await deleteDoc(doc(channelPinnedColRef(channelId), pid)); showToast('Pin removed'); await refreshPinned(channelId); }catch(e){console.error(e); showToast('Failed');} };
        el.appendChild(delbtn);
        adminPinnedList.appendChild(el);
      });
    }

    // rules button
    rulesBtn.addEventListener('click', ()=>{
      messagesDiv.innerHTML = '';
      const rules = [
        "1. Professional Conduct: Always be respectful.",
        "2. Confidentiality: Keep sensitive info private.",
        "3. No Spam: Avoid flooding channels.",
        "4. Respectful Banter: No harassment.",
        "5. Use proper channels for urgent matters.",
      ];
      rules.forEach(r=>{
        const el = document.createElement('div'); el.style.padding='14px'; el.style.borderRadius='12px'; el.style.background='linear-gradient(90deg, rgba(124,58,237,0.06), rgba(6,182,212,0.02))'; el.style.marginBottom='8px';
        el.innerHTML = `<strong style="color:var(--accent-1)">${r}</strong>`;
        messagesDiv.appendChild(el);
      });
    });

    // emoji modal wiring
    emojiBtn.addEventListener('click', ()=>{ emojiModal.style.display='block'; emojiModal.classList.remove('hidden'); });
    closeEmoji.addEventListener('click', ()=>{ emojiModal.style.display='none'; emojiModal.classList.add('hidden'); });

    // small initial render
    renderChannels();
    populateEmojiCategory('smile');

    // initialize firebase
    init().catch(console.error);
  </script>
</body>
</html>
